stages:
  - build

variables:
  # ---- Build matrix ----
  TERRAFORM_VERSION: "1.5.7"
  PY_VERSIONS: "3.11 3.12 3.13 3.14"
  DOCKER_BUILDKIT: "1"

  # ---- Snowflake connection (provided) ----
  SNOWFLAKE_ACCOUNT_LOCATOR: "GQ96773"
  SNOWFLAKE_ORG: "MLWWZGB"
  SNOWFLAKE_REGION: "AWS_SA_EAST_1"
  SNOWFLAKE_USER: "JOHNPOC022026"
  SNOWFLAKE_ROLE: "ACCOUNTADMIN"

  # IMPORTANT:
  # Snowflake CLI "account" should be ORG-ACCOUNT_LOCATOR (most common pattern)
  SNOWFLAKE_ACCOUNT: "${SNOWFLAKE_ORG}-${SNOWFLAKE_ACCOUNT_LOCATOR}"

  # ---- Snowflake objects (SPCS) ----
  SNOWFLAKE_DB: "POC_SPCS_DB"
  SNOWFLAKE_SCHEMA: "POC_SPCS_SCHEMA"
  SNOWFLAKE_IMAGE_REPO: "POC_REPO"
  IMAGE_NAME: "ds-repo-docker-custom-image"

default:
  image:
    name: docker:27.3.1-cli
    entrypoint: [""]

build_and_push_to_snowflake:
  stage: build
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache bash curl jq git python3 py3-pip
    - apk add --no-cache build-base g++ python3-dev libffi-dev openssl-dev

    - pip3 install --no-cache-dir --upgrade pip
    - pip3 install --no-cache-dir snowflake-cli

    # Fail-fast for password (must be defined in GitLab CI/CD Variables)
    - : "${SNOWFLAKE_PASSWORD:?Missing SNOWFLAKE_PASSWORD GitLab variable}"

    - mkdir -p ~/.config/snowflake
    - |
      cat > ~/.config/snowflake/config.toml <<EOF
      [connections.gitlab_ci]
      account = "${SNOWFLAKE_ACCOUNT}"
      region = "${SNOWFLAKE_REGION}"
      user = "${SNOWFLAKE_USER}"
      password = "${SNOWFLAKE_PASSWORD}"
      role = "${SNOWFLAKE_ROLE}"
      EOF
    - chmod 600 ~/.config/snowflake/config.toml

    - snow --version
    - snow connection test -c gitlab_ci

    - snow spcs image-registry login -c gitlab_ci

    - export SNOWFLAKE_REGISTRY_HOST="$(echo "${SNOWFLAKE_ACCOUNT}" | tr '[:upper:]' '[:lower:]').registry.snowflakecomputing.com"
    - export SNOWFLAKE_REPO_URL="${SNOWFLAKE_REGISTRY_HOST}/$(echo "${SNOWFLAKE_DB}" | tr '[:upper:]' '[:lower:]')/$(echo "${SNOWFLAKE_SCHEMA}" | tr '[:upper:]' '[:lower:]')/$(echo "${SNOWFLAKE_IMAGE_REPO}" | tr '[:upper:]' '[:lower:]')"
    - echo "SNOWFLAKE_REPO_URL=${SNOWFLAKE_REPO_URL}"

  script: |
    set -euo pipefail
    export DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1}

    echo "Building versions: ${PY_VERSIONS}"
    for VERSION in ${PY_VERSIONS}; do
      TAG="py${VERSION//./}"
      FULL_IMAGE="${SNOWFLAKE_REPO_URL}/${IMAGE_NAME}:${TAG}"

      echo "Building ${FULL_IMAGE} (Python ${VERSION})"
      docker build \
        --pull \
        --build-arg PYTHON_VERSION="${VERSION}" \
        --build-arg TERRAFORM_VERSION="${TERRAFORM_VERSION}" \
        -t "${FULL_IMAGE}" \
        -f Dockerfile.multi .

      echo "Smoke test (python --version)..."
      docker run --rm "${FULL_IMAGE}" python --version || true

      echo "Pushing ${FULL_IMAGE}"
      docker push "${FULL_IMAGE}"
      echo "âœ“ Pushed ${FULL_IMAGE}"
    done

  only:
    - main
